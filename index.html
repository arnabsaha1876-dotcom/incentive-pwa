<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Incentive Calculator</title>

  <!-- PWA hooks (keep manifest.webmanifest + icons/ in repo) -->
  manifest.webmanifest
  <meta name="theme-color" content="#0f4c81"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  icons/icon-192.png

  <style>
    :root{
      --brand:#0f4c81;
      --bg:#f6f8fb; --card:#fff; --txt:#1f2937; --muted:#64748b;
      --bar-bg:#e6eaf0;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:16px 12px 80px}
    header{display:flex;align-items:center;gap:12px;margin:4px 0 12px}
    header h1{font-size:20px;margin:0}
    .card{background:var(--card);border:1px solid #e7ebf0;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:14px;margin:10px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){.row{grid-template-columns:1fr}}
    label{font-size:13px;color:#334155;margin-bottom:6px;display:block}
    .req::after{content:" *";color:#b91c1c}
    input[type=text]{width:100%;padding:12px 14px;border:1px solid #cbd5e1;border-radius:10px;font-size:16px}
    input.err{border-color:#ef4444;background:#fff1f2}
    .err-text{color:#b91c1c;font-size:12px;margin-top:6px;display:none}
    .btn{width:100%;padding:12px 16px;background:var(--brand);color:#fff;border:0;border-radius:10px;font-size:16px}
    .muted{color:var(--muted);font-size:12px}

    /* ===== Dynamic Progress Bar (labels positioned exactly under ticks) ===== */
    .barWrap{margin-top:8px}
    .bar{position:relative;height:18px;border-radius:10px;background:var(--bar-bg);overflow:hidden}
    .fill{position:absolute;left:0;top:0;height:100%;
      background:linear-gradient(90deg,#d32f2f,#f57c00,#fbc02d,#7cb342,#388e3c);
      transition:width .35s ease}
    .tick{position:absolute;top:0;height:100%;width:2px;background:#ffffff90;border-left:1px solid #9aa5b180}
    .labelsAbs{position:relative;height:18px;margin-top:6px}
    .labelsAbs span{position:absolute;transform:translateX(-50%);top:0;font-size:11px;color:var(--muted);white-space:nowrap}

    .callout{border-left:4px solid #ef6c00;background:#fff7ed;color:#7c3f10;padding:8px 10px;border-radius:8px;margin-top:12px;font-size:14px;display:none}

    /* ===== Speedometer (8‚Üí12‚Üí4 o'clock) ===== */
    .gauge{position:relative;background:var(--card);border:1px solid #e7ebf0;border-radius:12px;padding:10px;display:flex;flex-direction:column;align-items:center}
    svg{max-width:520px;width:100%;height:auto}
    .pointer{transform-origin:0 0;transition:transform .5s ease}
    .legend{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px;background:#fff;cursor:pointer}
    .chip .dot{width:10px;height:10px;border-radius:50%}

    /* Results */
    .stat{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed #e5e7eb}
    .stat:last-child{border-bottom:0}
    .stat b{font-size:16px}
    .green{color:#1b5e20}
    .red{color:#b91c1c}

    /* Rewards overlay */
    .reward{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.15);z-index:10}
    .reward.show{display:grid}
    .stage{position:relative;width:100%;height:100%}
    .confetti{position:absolute;top:-10px;width:10px;height:16px;opacity:.9;animation:fall linear forwards}
    @keyframes fall{to{transform:translateY(110vh) rotate(720deg);opacity:1}}
    .big-emoji{position:absolute;inset:auto 0 18% 0;text-align:center;font-size:56px;filter:drop-shadow(0 3px 8px rgba(0,0,0,.25))}
    .nudge{background:#fff3cd;border:1px solid #ffe08a;color:#7a5b00;padding:8px 12px;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      icons/icon-192.png
      <h1>Incentive Calculator</h1>
    </header>

    <!-- Inputs -->
    <div class="card">
      <div class="row">
        <div>
          <label class="req">üéØ Monthly Target (‚Çπ)</label>
          <input id="target" type="text" inputmode="numeric" placeholder="e.g., 1,00,000"/>
          <div class="err-text" id="err-target">Please enter your monthly target.</div>
        </div>
        <div>
          <label class="req">‚úÖ Achieved So Far (‚Çπ)</label>
          <input id="achieved" type="text" inputmode="numeric" placeholder="e.g., 97,000"/>
          <div class="err-text" id="err-achieved">Please enter your achieved amount.</div>
        </div>
      </div>
      <div style="margin-top:10px">
        <button class="btn" id="btnCalc">Show My Incentives</button>
      </div>
      <p class="muted">Numbers auto‚Äëformat in Indian style (e.g., 10,00,000). Save to your home screen.</p>
    </div>

    <!-- Dynamic Progress -->
    <div class="card">
      <h3 style="margin:6px 0 10px">Progress to Incentive</h3>
      <div class="barWrap">
        <div class="bar" id="bar">
          <div class="fill" id="barFill" style="width:0%"></div>
          <!-- ticks inserted dynamically -->
        </div>
        <div class="labelsAbs" id="barLabels"></div>
      </div>
      <div id="nearMiss" class="callout">‚ö†Ô∏è <b>Don‚Äôt leave money on the table:</b> You‚Äôre <span id="missAmt"></span> away from 95%.</div>
    </div>

    <!-- Results -->
    <div class="card" id="results" style="display:none">
      <h3 style="margin:6px 0 12px">Your Incentive Snapshot</h3>
      <div class="stat"><span>Achievement %</span><b id="outPct">‚Äî</b></div>
      <div class="stat"><span>Current Incentive</span><b id="outIncentive">‚Äî</b></div>
      <div class="stat"><span>Next Slab @</span><b id="outNextSlab">‚Äî</b></div>
      <div class="stat"><span>Do more to reach next slab</span><b id="outGap">‚Äî</b></div>
      <div class="stat"><span>Incentive at next slab</span><b id="outNextInc">‚Äî</b></div>
      <p class="muted" id="outMsg" style="margin-top:8px"></p>
    </div>

    <!-- Speedometer + Zone details -->
    <div class="gauge">
      <h3 style="margin:6px 0 6px">Incentive Speedometer</h3>
      <!-- viewBox centered on origin; arc from 8 o'clock (240¬∞) to 4 o'clock (120¬∞) -->
      <svg viewBox="-110 -120 220 170" id="gaugeSvg" aria-label="Speedometer">
        <g id="zones"></g>
        <g id="pointerGroup" transform="">
          <polygon id="pointer" class="pointer" points="0,0 4,-6 0,-72 -4,-6" fill="#111"/>
          <circle cx="0" cy="0" r="5" fill="#111"/>
        </g>
      </svg>
      <div class="legend" id="legend"></div>
      <div class="card" style="width:100%;max-width:720px">
        <h4 style="margin:4px 0 6px">Zone details</h4>
        <div id="zoneBody" class="muted">Tap a colored arc or chip to see absolute ‚Çπ min/max, rate, your gap, and example incentive.</div>
      </div>
    </div>
  </div>

  <!-- Rewards overlay -->
  <div class="reward" id="reward">
    <div class="stage" id="stage"></div>
    <div class="big-emoji" id="rewardEmoji">üéâ</div>
  </div>

  <script>
    /*********************
     * Indian number mask (with caret preservation)
     *********************/
    const INRfmt = new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 });
    const INR = new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:0 });
    const PCT = v => (Math.round(v*10)/10)+'%';
    const onlyDigits = s => (s || '').replace(/[^\d]/g,'');
    const parseINR = s => Number(onlyDigits(s));
    function formatIndian(nStr){
      const s = onlyDigits(nStr);
      if (!s) return '';
      const last3 = s.slice(-3);
      const head = s.slice(0, -3);
      const headFmt = head ? head.replace(/\B(?=(\d{2})+(?!\d))/g, ',') : '';
      return headFmt ? headFmt + ',' + last3 : last3;
    }
    function attachMask(inputId, errId){
      const el = document.getElementById(inputId);
      const err = document.getElementById(errId);
      function digitsBeforeCaret(value, caret){
        let c=0; for (let i=0;i<caret;i++) if (/\d/.test(value[i])) c++; return c;
      }
      function caretFromDigits(formatted, d){
        if (d<=0) return 0; let c=0;
        for (let i=0;i<formatted.length;i++){ if (/\d/.test(formatted[i])) c++; if (c===d) return i+1; }
        return formatted.length;
      }
      el.addEventListener('focus', ()=>{ err.style.display='none'; el.classList.remove('err'); });
      el.addEventListener('input', ()=>{
        const raw = el.value;
        const sel = el.selectionStart || raw.length;
        const dBefore = digitsBeforeCaret(raw, sel);
        const formatted = formatIndian(raw);
        el.value = formatted;
        const newCaret = caretFromDigits(formatted, dBefore);
        el.setSelectionRange(newCaret, newCaret);
      });
      el.addEventListener('blur', ()=>{ el.value = formatIndian(el.value); });
    }

    /*********************
     * Slabs & rates
     *********************/
    const SLABS = [
      { name:'Zone 1',  min:0,   max:95,   rate:0.00, color:'#d32f2f', label:'0‚Äì95% (No incentive)' },
      { name:'Zone 2',  min:95,  max:100,  rate:0.01, color:'#ef6c00', label:'95‚Äì100% (0.5% at exactly 95%)' },
      { name:'Zone 3',  min:100, max:115,  rate:0.025,color:'#f9a825', label:'100‚Äì115%' },
      { name:'Zone 4',  min:115, max:125,  rate:0.035,color:'#c0ca33', label:'115‚Äì125%' },
      { name:'Zone 5',  min:125, max:150,  rate:0.04, color:'#8bc34a', label:'125‚Äì150%' },
      { name:'Zone 6',  min:150, max:200,  rate:0.05, color:'#66bb6a', label:'150‚Äì200%' },
      { name:'Zone 7',  min:200, max:300,  rate:0.06, color:'#43a047', label:'200‚Äì300%' },
      { name:'Zone 8',  min:300, max:9999, rate:0.08, color:'#2e7d32', label:'300%+' }
    ];
    const BOUNDS = [0,95,100,115,125,150,200,300];
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

    function rateFor(pct, achieved, target){
      if (pct < 95) return 0;
      const exactly95 = Math.abs(achieved - 0.95*target) < 0.5;
      if (exactly95) return 0.005;
      if (pct < 100) return 0.01;
      if (pct < 115) return 0.025;
      if (pct < 125) return 0.035;
      if (pct < 150) return 0.04;
      if (pct < 200) return 0.05;
      if (pct < 300) return 0.06;
      return 0.08;
    }
    function nextThresholdPct(pct, exactly95){
      if (pct < 95) return 95;
      if (exactly95) return 100;
      if (pct < 100) return 100;
      if (pct < 115) return 115;
      if (pct < 125) return 125;
      if (pct < 150) return 150;
      if (pct < 200) return 200;
      if (pct < 300) return 300;
      return null;
    }
    function slabIndexForPct(pct, exactly95){
      if (pct < 95) return 0;
      if (exactly95) return 1;
      if (pct < 100) return 1;
      if (pct < 115) return 2;
      if (pct < 125) return 3;
      if (pct < 150) return 4;
      if (pct < 200) return 5;
      if (pct < 300) return 6;
      return 7;
    }

    /*********************
     * Dynamic Progress Bar
     *********************/
    function ceilingForProgress(pct){
      if (pct < 95) return 95;
      if (pct < 100) return 115;
      if (pct < 115) return 115;
      if (pct < 125) return 125;
      if (pct < 150) return 150;
      if (pct < 200) return 200;
      if (pct < 300) return 300;
      return 300;
    }
    function buildProgressBar(scaleMaxPct, target){
      const bar  = document.getElementById('bar');
      const labs = document.getElementById('barLabels');
      [...bar.querySelectorAll('.tick')].forEach(n=>n.remove());
      labs.innerHTML = '';

      const ticks = BOUNDS.filter(b => b<=scaleMaxPct);
      ticks.forEach(p=>{
        const pos = (p/scaleMaxPct)*100;
        const t = document.createElement('div');
        t.className='tick'; t.style.left = `calc(${pos}% - 1px)`;
        bar.appendChild(t);

        const sp = document.createElement('span');
        sp.style.left = `${pos}%`;
        sp.textContent = p+'%';
        labs.appendChild(sp);
      });
    }

    /*********************
     * Speedometer (8‚Üí12‚Üí4 o'clock)
     * - Origin at (0,0)
     * - Arc endpoints: (-80,-20) and (80,-20)
     * - Angle mapping: 0%‚Üí240¬∞, 300%‚Üí120¬∞ (clockwise sweep)
     *********************/
    const zonesG = document.getElementById('zones');
    const legend = document.getElementById('legend');
    const pointerGroup = document.getElementById('pointerGroup');

    // Compute radius from (-80,-20) to origin
    const RADIUS = Math.hypot(80,20);        // ‚âà 82.46
    const START_DEG = 240;                   // 8 o'clock
    const END_DEG   = 120;                   // 4 o'clock
    const pctToDeg = p => START_DEG + (clamp(p,0,300)/300)*(END_DEG-START_DEG); // linear map along arc

    function deg2rad(d){return (Math.PI/180)*d}
    function xyForAngle(angleDeg){
      const a = deg2rad(angleDeg);
      // math-style coords; SVG y is downwards so invert y
      const x = RADIUS * Math.cos(a);
      const y = -RADIUS * Math.sin(a);
      return [x,y];
    }
    function arcPath(fromDeg, toDeg){
      const [sx,sy] = xyForAngle(fromDeg), [ex,ey] = xyForAngle(toDeg);
      const delta = ((toDeg - fromDeg) % 360 + 360) % 360;     // normalize
      const largeArc = (Math.abs(delta) > 180) ? 1 : 0;
      const sweep = (toDeg > fromDeg) ? 1 : 0;                 // 1 = clockwise
      return `M ${sx} ${sy} A ${RADIUS} ${RADIUS} 0 ${largeArc} ${sweep} ${ex} ${ey}`;
    }

    function buildGauge(){
      zonesG.innerHTML=''; legend.innerHTML='';
      SLABS.forEach((z,idx)=>{
        const sPct = Math.max(z.min,0);
        const ePct = Math.min(z.max,300);
        const sAng = pctToDeg(sPct);
        const eAng = pctToDeg(ePct);

        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', arcPath(sAng, eAng));
        path.setAttribute('stroke', z.color);
        path.setAttribute('stroke-width','14');
        path.setAttribute('fill','none');
        path.style.cursor='pointer';
        path.addEventListener('click', ()=> showZoneDetails(idx));
        zonesG.appendChild(path);

        const chip = document.createElement('div');
        chip.className='chip';
        chip.innerHTML = `<span class="dot" style="background:${z.color}"></span>${z.name}`;
        chip.onclick = ()=> showZoneDetails(idx);
        legend.appendChild(chip);
      });
    }
    function rotatePointerTo(pct){
      const ang = pctToDeg(pct);
      pointerGroup.setAttribute('transform', `rotate(${ang})`);
    }

    function showZoneDetails(i){
      const t = parseINR(document.getElementById('target').value);
      const a = parseINR(document.getElementById('achieved').value);
      const b = document.getElementById('zoneBody');
      const z = SLABS[i];

      if (!t){ b.innerHTML = 'Enter Target & Achieved to compute absolute amounts.'; return; }

      const minAbs = Math.ceil((z.min/100)*t);
      const maxAbs = (z.max>=300? null : Math.floor((z.max/100)*t));
      const gap = Math.max(0, minAbs - a);

      const rateText = (z.min===95 && z.max===100) ? '0.5% at exactly 95%; otherwise 1.0%' : (z.rate*100).toFixed(1)+'%';
      const incAt95 = Math.floor(0.95*t*0.005);
      const incAtMin = z.min===95 && z.max===100 ? Math.floor(minAbs*0.01) : Math.floor(minAbs*z.rate);

      let html = `<p><b>${z.name}</b> ‚Äî ${z.label}</p>`;
      html += `<p>Achievement range: <b>${z.min}%</b> to <b>${z.max>=300?'300%+':z.max+'%'}</b></p>`;
      html += `<p>Absolute range: <b>${INR.format(minAbs)}</b> to <b>${maxAbs?INR.format(maxAbs):'‚àû'}</b></p>`;
      if (z.min===95 && z.max===100){
        html += `<p>Rate: <b>${rateText}</b> (Example incentive at 95%: ${INR.format(incAt95)})</p>`;
      }else{
        html += `<p>Rate: <b>${rateText}</b> (Incentive at zone minimum: ${INR.format(incAtMin)})</p>`;
      }
      html += `<p>Gap to enter this zone: <b class="${gap>0?'red':'green'}">${gap>0?INR.format(gap):'You are in / above this zone'}</b></p>`;
      b.innerHTML = html;
    }

    /*********************
     * Rewards
     *********************/
    let lastSlabIdx = -1;
    const REWARD_EMOJIS = ['üí™','üéâ','üëè','ü•â','ü•à','ü•á','üèÜ','üëë']; // zone1 uses üí™ nudge
    function triggerRewardIfSlabAdvanced(pct, exactly95){
      const idx = slabIndexForPct(pct, exactly95);
      if (idx>lastSlabIdx){
        lastSlabIdx = idx;
        runReward(idx);
      }
    }
    function runReward(idx){
      const overlay = document.getElementById('reward');
      const stage = document.getElementById('stage');
      const emoji = document.getElementById('rewardEmoji');
      stage.innerHTML='';
      overlay.classList.add('show');

      if (idx===0){
        // Nudge only
        emoji.textContent = REWARD_EMOJIS[0];
        const note = document.createElement('div');
        note.className = 'nudge';
        note.innerHTML = 'Keep pushing ‚Äî almost at the incentive zone!';
        note.style.position='absolute'; note.style.left='50%'; note.style.bottom='20%';
        note.style.transform='translateX(-50%)';
        stage.appendChild(note);
        setTimeout(()=> overlay.classList.remove('show'), 1600);
        return;
      }

      emoji.textContent = REWARD_EMOJIS[idx] || 'üéâ';
      // Confetti amount increases with slab
      const colors = ['#ff5252','#ffd740','#69f0ae','#40c4ff','#b388ff','#ff8a80'];
      const count = 60 + idx*25;
      for (let i=0;i<count;i++){
        const d = document.createElement('div');
        d.className='confetti';
        d.style.left = Math.random()*100 + 'vw';
        d.style.background = colors[i % colors.length];
        d.style.transform = `translateY(-10px) rotate(${Math.random()*360}deg)`;
        d.style.animationDuration = (2 + Math.random()*2) + 's';
        d.style.animationDelay = (Math.random()*0.6)+'s';
        stage.appendChild(d);
      }
      setTimeout(()=> overlay.classList.remove('show'), 2200);
    }

    /*********************
     * Validation + Calculation
     *********************/
    function validateInputs(){
      const tEl = document.getElementById('target');
      const aEl = document.getElementById('achieved');
      const tErr = document.getElementById('err-target');
      const aErr = document.getElementById('err-achieved');
      let ok = true;

      if (!onlyDigits(tEl.value)){ tEl.classList.add('err'); tErr.style.display='block'; ok=false; }
      else { tEl.classList.remove('err'); tErr.style.display='none'; }

      if (!onlyDigits(aEl.value)){ aEl.classList.add('err'); aErr.style.display='block'; ok=false; }
      else { aEl.classList.remove('err'); aErr.style.display='none'; }

      return ok;
    }

    function calculate(){
      if (!validateInputs()) return;

      const target = parseINR(document.getElementById('target').value);
      const achieved = parseINR(document.getElementById('achieved').value);

      const pct = target ? (achieved/target)*100 : 0;
      const exactly95 = Math.abs(achieved - 0.95*target) < 0.5;
      const rateNow = rateFor(pct, achieved, target);
      const incentiveNow = Math.floor(achieved * rateNow);

      const nextPct = nextThresholdPct(pct, exactly95);
      let gap=0, atNextIncentive=0;
      if (nextPct!==null){
        const nextAbs = Math.ceil((nextPct/100)*target);
        gap = Math.max(0, nextAbs - achieved);
        const rateNext = rateFor(nextPct, nextAbs, target);
        atNextIncentive = Math.floor(nextAbs * rateNext);
      }

      // Results
      document.getElementById('results').style.display='block';
      document.getElementById('outPct').innerText = PCT(pct);
      document.getElementById('outIncentive').innerText = INR.format(incentiveNow);
      document.getElementById('outNextSlab').innerText = nextPct===null ? 'Top slab (300%+)' : `${nextPct}% (${INR.format((nextPct/100)*target)})`;
      document.getElementById('outGap').innerText = nextPct===null ? '‚Äî' : INR.format(gap);
      document.getElementById('outNextInc').innerText = nextPct===null ? INR.format(incentiveNow) : INR.format(atNextIncentive);

      // Near-miss
      const miss = document.getElementById('nearMiss');
      if (pct>=93 && pct<95){
        miss.style.display='block';
        document.getElementById('missAmt').innerText = INR.format(Math.ceil(0.95*target - achieved));
      } else { miss.style.display='none'; }

      // Dynamic progress bar
      const ceiling = (pct<95)?95 : (pct<100||pct<115?115 : (pct<125?125 : (pct<150?150 : (pct<200?200 : 300))));
      buildProgressBar(ceiling, target);
      const pctOnScale = clamp((pct/ceiling)*100, 0, 100);
      document.getElementById('barFill').style.width = pctOnScale + '%';

      // Speedometer pointer
      rotatePointerTo(pct);

      // Rewards
      triggerRewardIfSlabAdvanced(pct, exactly95);
    }

    /*********************
     * Init
     *********************/
    attachMask('target','err-target');
    attachMask('achieved','err-achieved');
    buildGauge();

    // Button
    document.getElementById('btnCalc').addEventListener('click', calculate);

    // PWA SW
    if ('serviceWorker' in navigator){
      navigator.serviceWorker.register('./service-worker.js');
    }
  </script>
</body>
</html>
