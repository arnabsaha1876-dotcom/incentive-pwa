<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Incentive Calculator</title>

  <!-- PWA hooks (keep your manifest.webmanifest and icons/ in the repo root) -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0f4c81" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    :root{
      --brand:#0f4c81;
      --bg:#f6f8fb;
      --card:#ffffff;
      --txt:#1f2937;
      --bar-bg:#e6eaf0;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:16px 12px 80px}
    header{display:flex;align-items:center;gap:12px;margin:4px 0 12px}
    header h1{font-size:20px;margin:0}
    .card{background:var(--card);border:1px solid #e7ebf0;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:14px;margin:10px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){.row{grid-template-columns:1fr}}
    label{font-size:13px;color:#334155;margin-bottom:6px;display:block}
    .req::after{content:" *";color:#b91c1c}
    input[type=text]{width:100%;padding:12px 14px;border:1px solid #cbd5e1;border-radius:10px;font-size:16px}
    input.err{border-color:#ef4444;background:#fff1f2}
    .err-text{color:#b91c1c;font-size:12px;margin-top:6px;display:none}
    .btn{width:100%;padding:12px 16px;background:var(--brand);color:#fff;border:0;border-radius:10px;font-size:16px}
    .muted{color:#64748b;font-size:12px}

    /* Dynamic Progress Bar */
    .barWrap{margin-top:8px}
    .bar{position:relative;height:18px;border-radius:10px;background:var(--bar-bg);overflow:hidden}
    .fill{position:absolute;left:0;top:0;height:100%;
      background:linear-gradient(90deg,#d32f2f,#f57c00,#fbc02d,#7cb342,#388e3c);
      transition:width .35s ease}
    .tick{position:absolute;top:0;height:100%;width:2px;background:#ffffff90;border-left:1px solid #9aa5b180}
    .labels{display:flex;justify-content:space-between;font-size:11px;color:#64748b;margin-top:6px}
    .callout{border-left:4px solid #ef6c00;background:#fff7ed;color:#7c3f10;padding:8px 10px;border-radius:8px;margin-top:12px;font-size:14px;display:none}

    /* Speedometer (new geometry from (-80,-20) to (80,-20)) */
    .gauge{position:relative;background:var(--card);border:1px solid #e7ebf0;border-radius:12px;padding:10px;display:flex;flex-direction:column;align-items:center}
    svg{max-width:520px;width:100%;height:auto}
    .pointer{transform-origin:0 0;transition:transform .5s ease}
    .legend{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px;background:#fff;cursor:pointer}
    .chip .dot{width:10px;height:10px;border-radius:50%}

    /* Results */
    .stat{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed #e5e7eb}
    .stat:last-child{border-bottom:0}
    .stat b{font-size:16px}
    .green{color:#1b5e20}
    .red{color:#b91c1c}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="icons/icon-192.png" alt="" width="28" height="28" />
      <h1>Incentive Calculator</h1>
    </header>

    <!-- Inputs -->
    <div class="card">
      <div class="row">
        <div>
          <label class="req">üéØ Monthly Target (‚Çπ)</label>
          <input id="target" type="text" inputmode="numeric" placeholder="e.g., 1,00,000" />
          <div class="err-text" id="err-target">Please enter your monthly target.</div>
        </div>
        <div>
          <label class="req">‚úÖ Achieved So Far (‚Çπ)</label>
          <input id="achieved" type="text" inputmode="numeric" placeholder="e.g., 97,000" />
          <div class="err-text" id="err-achieved">Please enter your achieved amount.</div>
        </div>
      </div>
      <div style="margin-top:10px">
        <button class="btn" id="btnCalc">Show My Incentives</button>
      </div>
      <p class="muted">Numbers auto‚Äëformat in Indian style (e.g., 10,00,000). Save to your phone home screen for 1‚Äëtap access.</p>
    </div>

    <!-- Dynamic Progress -->
    <div class="card">
      <h3 style="margin:6px 0 10px">Progress to Incentive</h3>
      <div class="barWrap">
        <div class="bar" id="bar">
          <div class="fill" id="barFill" style="width:0%"></div>
          <!-- ticks inserted dynamically -->
        </div>
        <div class="labels" id="barLabels"></div>
      </div>
      <div id="nearMiss" class="callout">‚ö†Ô∏è <b>Don‚Äôt leave money on the table:</b> You‚Äôre <span id="missAmt"></span> away from 95%.</div>
    </div>

    <!-- Results -->
    <div class="card" id="results" style="display:none">
      <h3 style="margin:6px 0 12px">Your Incentive Snapshot</h3>
      <div class="stat"><span>Achievement %</span><b id="outPct">‚Äî</b></div>
      <div class="stat"><span>Current Incentive</span><b id="outIncentive">‚Äî</b></div>
      <div class="stat"><span>Next Slab @</span><b id="outNextSlab">‚Äî</b></div>
      <div class="stat"><span>Do more to reach next slab</span><b id="outGap">‚Äî</b></div>
      <div class="stat"><span>Incentive at next slab</span><b id="outNextInc">‚Äî</b></div>
      <p class="muted" id="outMsg" style="margin-top:8px"></p>
    </div>

    <!-- Speedometer (new arc endpoints) -->
    <div class="gauge">
      <h3 style="margin:6px 0 6px">Incentive Speedometer</h3>
      <!-- ViewBox centered around (0,0) so the pointer base is at origin -->
      <svg viewBox="-110 -110 220 180" id="gaugeSvg" aria-label="Speedometer">
        <g id="zones"></g>
        <!-- Pointer: base at (0,0), length ~72 -->
        <g id="pointerGroup" transform="">
          <polygon id="pointer" class="pointer" points="0,0 4,-6 0,-72 -4,-6" fill="#111"/>
          <circle cx="0" cy="0" r="5" fill="#111"/>
        </g>
        <!-- Optional: baseline from (-80,-20) to (80,-20) -->
        <!-- <line x1="-80" y1="-20" x2="80" y2="-20" stroke="#cbd5e1" /> -->
      </svg>
      <div class="legend" id="legend"></div>
    </div>
  </div>

  <script>
    /*********************
     * FORMAT & PARSE (Indian commas with caret preservation)
     *********************/
    const INRfmt = new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 });
    const INR = new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:0 });
    const PCT = v => (Math.round(v*10)/10)+'%';
    const onlyDigits = s => (s || '').replace(/[^\d]/g,'');
    const parseINR = s => Number(onlyDigits(s));

    // Format "Indian" grouping (12,34,56,789)
    function formatIndian(nStr){
      const s = onlyDigits(nStr);
      if (!s) return '';
      const last3 = s.slice(-3);
      const head = s.slice(0, -3);
      const headFmt = head ? head.replace(/\B(?=(\d{2})+(?!\d))/g, ',') : '';
      return headFmt ? headFmt + ',' + last3 : last3;
    }

    // Keep caret near where user was typing
    function attachMask(inputId, errId){
      const el = document.getElementById(inputId);
      const err = document.getElementById(errId);

      function digitsBeforeCaret(value, caret){
        let c=0;
        for (let i=0;i<caret;i++) if (/\d/.test(value[i])) c++;
        return c;
      }
      function caretFromDigits(formatted, digitsCount){
        if (digitsCount<=0) return 0;
        let c=0;
        for (let i=0;i<formatted.length;i++){
          if (/\d/.test(formatted[i])) c++;
          if (c===digitsCount) return i+1;
        }
        return formatted.length;
      }

      el.addEventListener('focus', ()=>{
        err.style.display='none';
        el.classList.remove('err');
      });

      el.addEventListener('input', ()=>{
        const raw = el.value;
        const sel = el.selectionStart || raw.length;
        const dBefore = digitsBeforeCaret(raw, sel);
        const formatted = formatIndian(raw);
        el.value = formatted;
        const newCaret = caretFromDigits(formatted, dBefore);
        el.setSelectionRange(newCaret, newCaret);
      });

      // Also reformat on blur just in case
      el.addEventListener('blur', ()=>{
        el.value = formatIndian(el.value);
      });
    }

    /*********************
     * SLABS & RATES (your table)
     *********************/
    const SLABS = [
      { name:'Zone 1',  min:0,   max:95,   rate:0.00, color:'#d32f2f', label:'0‚Äì95% (No incentive)' },
      // Zone 2 special: exactly 95% ‚Üí 0.5%; >95 & <100 ‚Üí 1.0%
      { name:'Zone 2',  min:95,  max:100,  rate:0.01, color:'#ef6c00', label:'95‚Äì100% (0.5% at exactly 95%)' },
      { name:'Zone 3',  min:100, max:115,  rate:0.025,color:'#f9a825', label:'100‚Äì115%' },
      { name:'Zone 4',  min:115, max:125,  rate:0.035,color:'#c0ca33', label:'115‚Äì125%' },
      { name:'Zone 5',  min:125, max:150,  rate:0.04, color:'#8bc34a', label:'125‚Äì150%' },
      { name:'Zone 6',  min:150, max:200,  rate:0.05, color:'#66bb6a', label:'150‚Äì200%' },
      { name:'Zone 7',  min:200, max:300,  rate:0.06, color:'#43a047', label:'200‚Äì300%' },
      { name:'Zone 8',  min:300, max:9999, rate:0.08, color:'#2e7d32', label:'300%+' }
    ];
    const BOUNDS = [0,95,100,115,125,150,200,300];

    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

    function rateFor(pct, achieved, target){
      if (pct < 95) return 0;
      const exactly95 = Math.abs(achieved - 0.95*target) < 0.5;
      if (exactly95) return 0.005;           // 0.5% at exactly 95%
      if (pct >= 95 && pct < 100) return 0.01;
      if (pct >= 100 && pct < 115) return 0.025;
      if (pct >= 115 && pct < 125) return 0.035;
      if (pct >= 125 && pct < 150) return 0.04;
      if (pct >= 150 && pct < 200) return 0.05;
      if (pct >= 200 && pct < 300) return 0.06;
      if (pct >= 300) return 0.08;
      return 0;
    }
    function nextThresholdPct(pct, exactly95){
      if (pct < 95) return 95;
      if (exactly95) return 100;
      if (pct < 100) return 100;
      if (pct < 115) return 115;
      if (pct < 125) return 125;
      if (pct < 150) return 150;
      if (pct < 200) return 200;
      if (pct < 300) return 300;
      return null;
    }
    function slabIndexForPct(pct, exactly95){
      if (pct < 95) return 0;
      if (exactly95) return 1;
      if (pct < 100) return 1;
      if (pct < 115) return 2;
      if (pct < 125) return 3;
      if (pct < 150) return 4;
      if (pct < 200) return 5;
      if (pct < 300) return 6;
      return 7;
    }

    /*********************
     * DYNAMIC PROGRESS BAR
     * Rule: Always show from 0% up to the END of the CURRENT slab.
     * Examples:
     * - In 95‚Äì100%  ‚Üí ticks: 0, 95, 100, 115
     * - In 125‚Äì150% ‚Üí ticks: 0, 95, 100, 115, 125, 150
     *********************/
    function ceilingForProgress(pct){
      if (pct < 95) return 95;
      if (pct < 100) return 115;
      if (pct < 115) return 115;
      if (pct < 125) return 125;
      if (pct < 150) return 150;
      if (pct < 200) return 200;
      if (pct < 300) return 300;
      return 300;
    }

    function buildProgressBar(scaleMaxPct){
      const bar = document.getElementById('bar');
      const labels = document.getElementById('barLabels');
      // remove old ticks
      [...bar.querySelectorAll('.tick')].forEach(n=>n.remove());
      labels.innerHTML = '';

      // ticks from 0 up to ceiling
      const ticks = BOUNDS.filter(b => b<=scaleMaxPct);
      ticks.forEach(p=>{
        const t = document.createElement('div');
        t.className='tick';
        const pctPos = (p/scaleMaxPct)*100;
        t.style.left = `calc(${pctPos}% - 1px)`;
        bar.appendChild(t);

        const lab = document.createElement('span');
        lab.textContent = p+'%';
        labels.appendChild(lab);
      });
    }

    /*********************
     * NEW SPEEDOMETER GEOMETRY (arc from ‚àí80,‚àí20 to 80,‚àí20)
     *********************/
    const zonesG = document.getElementById('zones');
    const legend = document.getElementById('legend');
    const pointerGroup = document.getElementById('pointerGroup');

    // Geometry constants:
    // Radius that passes through points (-80,-20) and (80,-20)
    const RADIUS = Math.hypot(80,20);     // ‚âà 82.46
    const START_DEG = -Math.atan2(20, -80) * 180/Math.PI; // ‚âà -166¬∞
    const END_DEG   = -Math.atan2(20,  80) * 180/Math.PI; // ‚âà -14¬∞
    const SPAN = END_DEG - START_DEG;    // ~152¬∞

    const pctToDeg = p => START_DEG + (clamp(p,0,300)/300)*SPAN;

    function deg2rad(d){return (Math.PI/180)*d}
    function xy(angleDeg){
      const a = deg2rad(angleDeg);
      // math-style coords with origin at center of gauge (SVG y is down, so invert)
      const x = RADIUS * Math.cos(a);
      const y = -RADIUS * Math.sin(a);
      return [x,y];
    }
    function pathArc(fromDeg, toDeg){
      const [sx,sy] = xy(fromDeg), [ex,ey] = xy(toDeg);
      const largeArc = (toDeg - fromDeg) > 180 ? 1 : 0;
      return `M ${sx} ${sy} A ${RADIUS} ${RADIUS} 0 ${largeArc} 1 ${ex} ${ey}`;
    }

    function buildGauge(){
      zonesG.innerHTML=''; legend.innerHTML='';
      SLABS.forEach((z,idx)=>{
        const s = Math.max(z.min, 0);
        const e = Math.min(z.max, 300);
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', pathArc(pctToDeg(s), pctToDeg(e)));
        path.setAttribute('stroke', z.color);
        path.setAttribute('stroke-width','14');
        path.setAttribute('fill','none');
        zonesG.appendChild(path);

        const chip = document.createElement('div');
        chip.className='chip';
        chip.innerHTML = `<span class="dot" style="background:${z.color}"></span>${z.name}`;
        legend.appendChild(chip);
      });
    }
    function rotatePointerTo(pct){
      const ang = pctToDeg(pct);
      pointerGroup.setAttribute('transform', `rotate(${ang})`);
    }

    /*********************
     * VALIDATION + CALC
     *********************/
    function validateInputs(){
      const tEl = document.getElementById('target');
      const aEl = document.getElementById('achieved');
      const tErr = document.getElementById('err-target');
      const aErr = document.getElementById('err-achieved');
      let ok = true;

      if (!onlyDigits(tEl.value)){ tEl.classList.add('err'); tErr.style.display='block'; ok=false; }
      else { tEl.classList.remove('err'); tErr.style.display='none'; }

      if (!onlyDigits(aEl.value)){ aEl.classList.add('err'); aErr.style.display='block'; ok=false; }
      else { aEl.classList.remove('err'); aErr.style.display='none'; }

      return ok;
    }

    function calculate(){
      if (!validateInputs()) return;

      const target = parseINR(document.getElementById('target').value);
      const achieved = parseINR(document.getElementById('achieved').value);

      const pct = target ? (achieved/target)*100 : 0;
      const exactly95 = Math.abs(achieved - 0.95*target) < 0.5;
      const rateNow = rateFor(pct, achieved, target);
      const incentiveNow = Math.floor(achieved * rateNow);

      const nextPct = nextThresholdPct(pct, exactly95);
      let gap=0, atNextIncentive=0;
      if (nextPct!==null){
        const nextAbs = Math.ceil((nextPct/100)*target);
        gap = Math.max(0, nextAbs - achieved);
        const rateNext = rateFor(nextPct, nextAbs, target);
        atNextIncentive = Math.floor(nextAbs * rateNext);
      }

      // Results
      document.getElementById('results').style.display='block';
      document.getElementById('outPct').innerText = PCT(pct);
      document.getElementById('outIncentive').innerText = INR.format(incentiveNow);
      document.getElementById('outNextSlab').innerText = nextPct===null ? 'Top slab (300%+)' : `${nextPct}% (${INR.format((nextPct/100)*target)})`;
      document.getElementById('outGap').innerText = nextPct===null ? '‚Äî' : INR.format(gap);
      document.getElementById('outNextInc').innerText = nextPct===null ? INR.format(incentiveNow) : INR.format(atNextIncentive);

      // Near-miss 93‚Äì95%
      const miss = document.getElementById('nearMiss');
      if (pct>=93 && pct<95){
        miss.style.display='block';
        document.getElementById('missAmt').innerText = INR.format(Math.ceil(0.95*target - achieved));
      } else { miss.style.display='none'; }

      // ===== Dynamic Progress Bar (0 ‚Üí end of current slab) =====
      const ceiling = ceilingForProgress(pct);
      buildProgressBar(ceiling);
      const pctOnScale = clamp((pct/ceiling)*100, 0, 100);
      document.getElementById('barFill').style.width = pctOnScale + '%';

      // ===== Speedometer pointer =====
      rotatePointerTo(pct);
    }

    /*********************
     * INIT
     *********************/
    // Indian-number masks (with caret preservation)
    attachMask('target','err-target');
    attachMask('achieved','err-achieved');

    // Build gauge zones once
    buildGauge();

    // Calculate on button click
    document.getElementById('btnCalc').addEventListener('click', calculate);

    // PWA Service Worker
    if ('serviceWorker' in navigator){
      navigator.serviceWorker.register('./service-worker.js');
    }
  </script>
</body>
</html>
``
