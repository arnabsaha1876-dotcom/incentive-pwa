<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Incentive Calculator</title>

  <!-- PWA & Icons (fixed) -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="theme-color" content="#0f4c81"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <!-- Soft anti-indexing -->
  <meta name="robots" content="noindex,nofollow"/>

  <style>
    :root{
      --brand:#0f4c81;
      --bg:#f6f8fb; --card:#fff; --txt:#1f2937; --muted:#64748b;
      --bar-bg:#e6eaf0;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:16px 12px 80px}
    header{display:flex;align-items:center;gap:10px;margin:4px 0 12px}
    header h1{font-size:20px;margin:0}
    .logo{width:24px;height:24px;border-radius:6px}

    .card{background:var(--card);border:1px solid #e7ebf0;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:14px;margin:10px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){.row{grid-template-columns:1fr}}
    label{font-size:13px;color:#334155;margin-bottom:6px;display:block}
    .req::after{content:" *";color:#b91c1c}
    input[type=text]{width:100%;padding:12px 14px;border:1px solid #cbd5e1;border-radius:10px;font-size:16px}
    input.err{border-color:#ef4444;background:#fff1f2}
    .err-text{color:#b91c1c;font-size:12px;margin-top:6px;display:none}
    .btn{width:100%;padding:12px 16px;background:var(--brand);color:#fff;border:0;border-radius:10px;font-size:16px}
    .muted{color:var(--muted);font-size:12px}

    /* ===== Progress Bar (absolute ‚Çπ segments) ===== */
    .barWrap{margin-top:8px}
    .bar{position:relative;height:18px;border-radius:10px;background:var(--bar-bg);overflow:hidden}
    .seg{position:absolute;top:0;height:100%}
    .seg1{background:#90caf9}  /* Achieved */
    .seg2{background:#ffe082}  /* To next min */
    .seg3{background:#c8e6c9}  /* Next slab span */
    .labelsAbs{position:relative;height:18px;margin-top:6px}
    .labelsAbs span{position:absolute;transform:translateX(-50%);top:0;font-size:11px;color:var(--muted);white-space:nowrap}
    .tick{position:absolute;top:0;height:100%;width:2px;background:#ffffffaa}

    .callout{border-left:4px solid #ef6c00;background:#fff7ed;color:#7c3f10;padding:8px 10px;border-radius:8px;margin-top:12px;font-size:14px;display:none}

    /* ===== Incentive Slabs gauge ===== */
    .gauge{position:relative;background:var(--card);border:1px solid #e7ebf0;border-radius:12px;padding:10px;display:flex;flex-direction:column;align-items:center}
    svg{max-width:520px;width:100%;height:auto}
    .pointer{transform-origin:0 0;transition:transform .5s ease}
    .legend{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px;background:#fff;cursor:pointer}
    .chip .dot{width:10px;height:10px;border-radius:50%}

    /* Results */
    .stat{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed #e5e7eb}
    .stat:last-child{border-bottom:0}
    .stat b{font-size:16px}
    .green{color:#1b5e20}
    .red{color:#b91c1c}

    /* Rewards */
    .reward{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.15);z-index:10}
    .reward.show{display:grid}
    .stage{position:relative;width:100%;height:100%}
    .confetti{position:absolute;top:-10px;width:10px;height:16px;opacity:.9;animation:fall linear forwards}
    @keyframes fall{to{transform:translateY(110vh) rotate(720deg);opacity:1}}
    .big-emoji{position:absolute;inset:auto 0 18% 0;text-align:center;font-size:56px;filter:drop-shadow(0 3px 8px rgba(0,0,0,.25))}
    .nudge{background:#fff3cd;border:1px solid #ffe08a;color:#7a5b00;padding:8px 12px;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img class="logo" src="icons/icon-192.png" alt="Logo" onerror="this.style.display='none'"/>
      <h1>Incentive Calculator</h1>
    </header>

    <!-- Inputs -->
    <div class="card">
      <div class="row">
        <div>
          <label class="req">üéØ Monthly Target (‚Çπ)</label>
          <input id="target" type="text" inputmode="numeric" placeholder="e.g., 1,00,000"/>
          <div class="err-text" id="err-target">Please enter your monthly target.</div>
        </div>
        <div>
          <label class="req">‚úÖ Achieved So Far (‚Çπ)</label>
          <input id="achieved" type="text" inputmode="numeric" placeholder="e.g., 97,000"/>
          <div class="err-text" id="err-achieved">Please enter your achieved amount.</div>
        </div>
      </div>
      <div style="margin-top:10px">
        <button class="btn" id="btnCalc">Show My Incentives</button>
      </div>
      <p class="muted">Numbers auto‚Äëformat in Indian style (e.g., 10,00,000). Save to your home screen.</p>
    </div>

    <!-- Progress (absolute ‚Çπ segments) -->
    <div class="card">
      <h3 style="margin:6px 0 10px">Progress to Incentive</h3>
      <div class="barWrap">
        <div class="bar" id="bar">
          <div class="seg seg1" id="seg1" style="left:0%;width:0%"></div>
          <div class="seg seg2" id="seg2" style="left:0%;width:0%"></div>
          <div class="seg seg3" id="seg3" style="left:0%;width:0%"></div>
          <!-- tick lines -->
          <div class="tick" id="tick0"  style="left:0%"></div>
          <div class="tick" id="tickA"  style="left:0%"></div>
          <div class="tick" id="tickN1" style="left:0%"></div>
          <div class="tick" id="tickN2" style="left:0%"></div>
        </div>
        <div class="labelsAbs" id="barLabels">
          <span id="lab0"  style="left:0%">‚Çπ0</span>
          <span id="labA"  style="left:0%">‚Äî</span>
          <span id="labN1" style="left:0%">‚Äî</span>
          <span id="labN2" style="left:0%">‚Äî</span>
        </div>
      </div>
      <div id="nearMiss" class="callout">‚ö†Ô∏è <b>Don‚Äôt leave money on the table:</b> You‚Äôre <span id="missAmt"></span> away from 95%.</div>
    </div>

    <!-- Results (Next Slab row removed) -->
    <div class="card" id="results" style="display:none">
      <h3 style="margin:6px 0 12px">Your Incentive Snapshot</h3>
      <div class="stat"><span>Achievement %</span><b id="outPct">‚Äî</b></div>
      <div class="stat"><span>Current Incentive</span><b id="outIncentive">‚Äî</b></div>
      <div class="stat"><span>Do more to reach next slab</span><b id="outGap">‚Äî</b></div>
      <div class="stat"><span>Incentive at next slab</span><b id="outNextInc">‚Äî</b></div>
      <p class="muted" id="outMsg" style="margin-top:8px"></p>
    </div>

    <!-- Incentive Slabs (renamed heading) -->
    <div class="gauge">
      <h3 style="margin:6px 0 6px">Incentive Slabs</h3>
      <svg viewBox="-110 -120 220 170" id="gaugeSvg" aria-label="Incentive Slabs">
        <g id="zones"></g>
        <g id="pointerGroup" style="pointer-events:none">
          <line id="needle" x1="0" y1="0" x2="72" y2="0" stroke="#111" stroke-width="4" stroke-linecap="round"/>
          <circle cx="0" cy="0" r="5" fill="#111"/>
        </g>
      </svg>
      <div class="legend" id="legend"></div>
      <div class="card" style="width:100%;max-width:720px">
        <h4 style="margin:4px 0 6px">Zone details</h4>
        <div id="zoneBody" class="muted">
          Tap a colored arc or chip to see: <b>Minimum incentive at this zone</b> and your <b>Gap to enter this zone</b>.
        </div>
      </div>
    </div>
  </div>

  <!-- Rewards overlay -->
  <div class="reward" id="reward">
    <div class="stage" id="stage"></div>
    <div class="big-emoji" id="rewardEmoji">üéâ</div>
  </div>

  <script>
    /* ========== Indian number mask ========== */
    const INRfmt = new Intl.NumberFormat('en-IN',{maximumFractionDigits:0});
    const INR = new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR',maximumFractionDigits:0});
    const PCT = v => (Math.round(v*10)/10)+'%';
    const onlyDigits = s => (s||'').replace(/[^\d]/g,'');
    const parseINR = s => Number(onlyDigits(s));
    function formatIndian(nStr){
      const s = onlyDigits(nStr); if (!s) return '';
      const last3 = s.slice(-3), head = s.slice(0,-3);
      const headFmt = head ? head.replace(/\B(?=(\d{2})+(?!\d))/g,',') : '';
      return headFmt ? headFmt+','+last3 : last3;
    }
    function attachMask(inputId, errId){
      const el=document.getElementById(inputId);
      const err=document.getElementById(errId);
      function digitsBeforeCaret(v,c){let d=0;for(let i=0;i<c;i++) if(/\d/.test(v[i])) d++;return d;}
      function caretFromDigits(f,d){if(d<=0) return 0;let c=0;for(let i=0;i<f.length;i++){if(/\d/.test(f[i])) c++; if(c===d) return i+1;} return f.length;}
      el.addEventListener('focus',()=>{err.style.display='none';el.classList.remove('err');});
      el.addEventListener('input',()=>{
        const raw=el.value, sel=el.selectionStart||raw.length, dB=digitsBeforeCaret(raw,sel);
        const f=formatIndian(raw); el.value=f; const nc=caretFromDigits(f,dB); el.setSelectionRange(nc,nc);
      });
      el.addEventListener('blur',()=>{el.value=formatIndian(el.value);});
    }

    /* ========== Slabs (colors kept; rates only for math, not shown) ========== */
    const SLABS = [
      { name:'Zone 1',  min:0,   max:95,   rate:0.00, color:'#D32F2F' },
      { name:'Zone 2',  min:95,  max:100,  rate:0.01, color:'#F57C00' },
      { name:'Zone 3',  min:100, max:115,  rate:0.025,color:'#F9A825' },
      { name:'Zone 4',  min:115, max:125,  rate:0.035,color:'#C0CA33' },
      { name:'Zone 5',  min:125, max:150,  rate:0.04, color:'#8BC34A' },
      { name:'Zone 6',  min:150, max:200,  rate:0.05, color:'#66BB6A' },
      { name:'Zone 7',  min:200, max:300,  rate:0.06, color:'#2E7D32' },
      { name:'Zone 8',  min:300, max:9999, rate:0.08, color:'#00695C' }
    ];
    const BOUNDS=[0,95,100,115,125,150,200,300];
    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

    function rateFor(pct, achieved, target){
      if (pct < 95) return 0;
      const exactly95 = Math.abs(achieved - 0.95*target) < 0.5;
      if (exactly95) return 0.005;
      if (pct < 100) return 0.01;
      if (pct < 115) return 0.025;
      if (pct < 125) return 0.035;
      if (pct < 150) return 0.04;
      if (pct < 200) return 0.05;
      if (pct < 300) return 0.06;
      return 0.08;
    }
    function nextThresholdPct(pct, exactly95){
      if (pct < 95) return 95;
      if (exactly95) return 100;
      if (pct < 100) return 100;
      if (pct < 115) return 115;
      if (pct < 125) return 125;
      if (pct < 150) return 150;
      if (pct < 200) return 200;
      if (pct < 300) return 300;
      return null;
    }
    function slabIndexForPct(pct, exactly95){
      if (pct < 95) return 0;
      if (exactly95) return 1;
      if (pct < 100) return 1;
      if (pct < 115) return 2;
      if (pct < 125) return 3;
      if (pct < 150) return 4;
      if (pct < 200) return 5;
      if (pct < 300) return 6;
      return 7;
    }

    /* ========== Progress Bar (absolute ‚Çπ segments) ========== */
    // Given achievement pct, return next slab min & max (pct)
    function getNextSlabBounds(pct, exactly95){
      // Map current slab to the *next* slab's min/max
      if (pct < 95)   return {nmin:95,  nmax:100};
      if (exactly95)  return {nmin:100, nmax:115};
      if (pct < 100)  return {nmin:100, nmax:115};
      if (pct < 115)  return {nmin:115, nmax:125};
      if (pct < 125)  return {nmin:125, nmax:150};
      if (pct < 150)  return {nmin:150, nmax:200};
      if (pct < 200)  return {nmin:200, nmax:300};
      if (pct < 300)  return {nmin:300, nmax:300};  // cap
      return {nmin:300, nmax:300};
    }

    function buildAbsoluteProgress(target, achieved){
      const bar = document.getElementById('bar');
      const seg1 = document.getElementById('seg1');
      const seg2 = document.getElementById('seg2');
      const seg3 = document.getElementById('seg3');

      const t0 = document.getElementById('tick0');
      const tA = document.getElementById('tickA');
      const tN1= document.getElementById('tickN1');
      const tN2= document.getElementById('tickN2');

      const l0 = document.getElementById('lab0');
      const lA = document.getElementById('labA');
      const lN1= document.getElementById('labN1');
      const lN2= document.getElementById('labN2');

      const pct = target ? (achieved/target)*100 : 0;
      const exactly95 = Math.abs(achieved - 0.95*target) < 0.5;

      const {nmin, nmax} = getNextSlabBounds(pct, exactly95);

      const A0   = 0;
      const Aach = Math.max(0, achieved);
      const Amin = Math.ceil((nmin/100)*target);
      const Amax = Math.ceil((nmax/100)*target);

      // Scale max is next slab MAX absolute (cap to avoid infinity)
      const scaleMax = Amax;
      const clampAch = Math.min(Aach, scaleMax);

      // Compute left/width percentages
      const pos = v => (v/scaleMax)*100;
      const left1 = pos(A0);
      const left2 = pos(clampAch);
      const left3 = pos(Amin);

      seg1.style.left = `${left1}%`;
      seg1.style.width = `${Math.max(0, left2-left1)}%`;

      seg2.style.left = `${left2}%`;
      seg2.style.width = `${Math.max(0, left3-left2)}%`;

      seg3.style.left = `${left3}%`;
      seg3.style.width = `${Math.max(0, 100-left3)}%`;

      // Ticks
      t0.style.left  = `${left1}%`;
      tA.style.left  = `${left2}%`;
      tN1.style.left = `${left3}%`;
      tN2.style.left = `100%`;

      // Labels (‚Çπ absolute; if in final zone, show "300%+" at end)
      l0.style.left = `${left1}%`;
      l0.textContent = INR.format(0);

      lA.style.left = `${left2}%`;
      lA.textContent = INR.format(clampAch);

      lN1.style.left = `${left3}%`;
      lN1.textContent = INR.format(Amin);

      lN2.style.left = `100%`;
      lN2.textContent = (nmax===300) ? (pct>=300 ? '300%+' : INR.format(Amax)) : INR.format(Amax);
    }

    /* ========== Incentive Slabs (gauge; already working) ========== */
    const zonesG=document.getElementById('zones');
    const legend=document.getElementById('legend');
    const pointerGroup=document.getElementById('pointerGroup');

    const RADIUS = Math.hypot(80, 20);
    const START_DEG = Math.atan2(-20, -80) * 180/Math.PI;
    const END_DEG   = Math.atan2(-20,  80) * 180/Math.PI;
    function pctToDeg(pct){ const p=clamp(pct,0,300); return START_DEG + (p/300)*(END_DEG - START_DEG); }
    function deg2rad(d){ return (Math.PI/180)*d; }
    function xy(angleDeg){ const a=deg2rad(angleDeg); return [ RADIUS*Math.cos(a), RADIUS*Math.sin(a) ]; }
    function arcPath(fromDeg,toDeg){
      const [sx,sy]=xy(fromDeg), [ex,ey]=xy(toDeg);
      const delta=toDeg-fromDeg, largeArc=Math.abs(delta)>180?1:0, sweep=delta>=0?1:0;
      return `M ${sx} ${sy} A ${RADIUS} ${RADIUS} 0 ${largeArc} ${sweep} ${ex} ${ey}`;
    }
    function buildGauge(){
      zonesG.innerHTML=''; legend.innerHTML='';
      SLABS.forEach((z,idx)=>{
        let sPct=Math.max(0,z.min), ePct=Math.min(300,z.max);
        if (z.min>=300){ sPct=296; ePct=300; } // tiny cap for 300%+
        const sAng=pctToDeg(sPct), eAng=pctToDeg(ePct);
        const path=document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d',arcPath(sAng,eAng));
        path.setAttribute('stroke',z.color);
        path.setAttribute('stroke-width','14');
        path.setAttribute('fill','none');
        path.style.cursor='pointer';
        path.addEventListener('click',()=>showZoneDetails(idx));
        zonesG.appendChild(path);

        const chip=document.createElement('div');
        chip.className='chip';
        chip.innerHTML=`<span class="dot" style="background:${z.color}"></span>${z.name}`;
        chip.onclick=()=>showZoneDetails(idx);
        legend.appendChild(chip);
      });
    }
    function rotatePointerTo(pct){
      const ang=pctToDeg(pct);
      pointerGroup.setAttribute('transform',`rotate(${ang})`);
    }

    // Zone details (privacy-trimmed): only min incentive & gap
    function showZoneDetails(i){
      const t=parseINR(document.getElementById('target').value);
      const a=parseINR(document.getElementById('achieved').value);
      const b=document.getElementById('zoneBody');
      const z=SLABS[i];
      if (!t){ b.innerHTML='Enter Target & Achieved to compute values.'; return; }

      const minAbs=Math.ceil((z.min/100)*t);
      const incAt95=Math.floor(0.95*t*0.005);
      const incAtMin = (z.min===95 && z.max===100)
        ? Math.floor(minAbs * 0.01)
        : Math.floor(minAbs * z.rate);
      const gap=Math.max(0,minAbs-a);

      let html = `<p><b>${z.name}</b></p>`;
      if (z.min===95 && z.max===100){
        html += `<p>Minimum incentive at this zone: <b>${INR.format(incAt95)}</b></p>`;
      } else {
        html += `<p>Minimum incentive at this zone: <b>${INR.format(incAtMin)}</b></p>`;
      }
      html += `<p>Gap to enter this zone: <b class="${gap>0?'red':'green'}">${gap>0?INR.format(gap):'You are in / above this zone'}</b></p>`;
      b.innerHTML = html;
    }

    /* ========== Rewards (unchanged) ========== */
    let lastSlabIdx=-1;
    const REWARD_EMOJIS=['üí™','üéâ','üëè','ü•â','ü•à','ü•á','üèÜ','üëë'];
    function triggerRewardIfSlabAdvanced(pct, exactly95){
      const idx=slabIndexForPct(pct, exactly95);
      if (idx>lastSlabIdx){ lastSlabIdx=idx; runReward(idx); }
    }
    function runReward(idx){
      const overlay=document.getElementById('reward');
      const stage=document.getElementById('stage');
      const emoji=document.getElementById('rewardEmoji');
      stage.innerHTML=''; overlay.classList.add('show');
      if (idx===0){
        emoji.textContent=REWARD_EMOJIS[0];
        const note=document.createElement('div');
        note.className='nudge'; note.innerHTML='Keep pushing ‚Äî almost at the incentive zone!';
        note.style.position='absolute'; note.style.left='50%'; note.style.bottom='20%'; note.style.transform='translateX(-50%)';
        stage.appendChild(note);
        setTimeout(()=> overlay.classList.remove('show'),1600);
        return;
      }
      emoji.textContent=REWARD_EMOJIS[idx] || 'üéâ';
      const colors=['#ff5252','#ffd740','#69f0ae','#40c4ff','#b388ff','#ff8a80'];
      const count=60+idx*25;
      for(let i=0;i<count;i++){
        const d=document.createElement('div');
        d.className='confetti';
        d.style.left=Math.random()*100+'vw';
        d.style.background=colors[i%colors.length];
        d.style.transform=`translateY(-10px) rotate(${Math.random()*360}deg)`;
        d.style.animationDuration=(2+Math.random()*2)+'s';
        d.style.animationDelay=(Math.random()*0.6)+'s';
        stage.appendChild(d);
      }
      setTimeout(()=> overlay.classList.remove('show'),2200);
    }

    /* ========== Validation + Calculation ========== */
    function validateInputs(){
      const tEl=document.getElementById('target');
      const aEl=document.getElementById('achieved');
      const tErr=document.getElementById('err-target');
      const aErr=document.getElementById('err-achieved');
      let ok=true;
      if (!onlyDigits(tEl.value)){ tEl.classList.add('err'); tErr.style.display='block'; ok=false; } else { tEl.classList.remove('err'); tErr.style.display='none'; }
      if (!onlyDigits(aEl.value)){ aEl.classList.add('err'); aErr.style.display='block'; ok=false; } else { aEl.classList.remove('err'); aErr.style.display='none'; }
      return ok;
    }

    function calculate(){
      if (!validateInputs()) return;

      const target=parseINR(document.getElementById('target').value);
      const achieved=parseINR(document.getElementById('achieved').value);
      const pct = target ? (achieved/target)*100 : 0;
      const exactly95 = Math.abs(achieved - 0.95*target) < 0.5;

      const rateNow=rateFor(pct, achieved, target);
      const incentiveNow=Math.floor(achieved*rateNow);

      const nextPct=nextThresholdPct(pct, exactly95);
      let gap=0, atNextIncentive=0;
      if (nextPct!==null){
        const nextAbs=Math.ceil((nextPct/100)*target);
        gap=Math.max(0, nextAbs-achieved);
        const rateNext=rateFor(nextPct, nextAbs, target);
        atNextIncentive=Math.floor(nextAbs*rateNext);
      }

      // Results (without the Next Slab row)
      document.getElementById('results').style.display='block';
      document.getElementById('outPct').innerText=PCT(pct);
      document.getElementById('outIncentive').innerText=INR.format(incentiveNow);
      document.getElementById('outGap').innerText = nextPct===null ? '‚Äî' : INR.format(gap);
      document.getElementById('outNextInc').innerText = nextPct===null ? INR.format(incentiveNow) : INR.format(atNextIncentive);

      // Near-miss
      const miss=document.getElementById('nearMiss');
      if (pct>=93 && pct<95){ miss.style.display='block'; document.getElementById('missAmt').innerText=INR.format(Math.ceil(0.95*target-achieved)); }
      else miss.style.display='none';

      // Absolute progress segments
      buildAbsoluteProgress(target, achieved);

      // Gauge pointer
      rotatePointerTo(pct);

      // Rewards
      triggerRewardIfSlabAdvanced(pct, exactly95);
    }

    /* ========== Init ========== */
    attachMask('target','err-target');
    attachMask('achieved','err-achieved');
    buildGauge();
    document.getElementById('btnCalc').addEventListener('click', calculate);

    if ('serviceWorker' in navigator){
      navigator.serviceWorker.register('./service-worker.js');
    }
  </script>
</body>
</html>
``
